# Проект "Бюро находок"

## Запуск проекта

1. Создайте виртуальное окружение
2. Установите зависимости из файла requirements.txt
3. Создайте файл .env.local, используя .env.local.examples
4. Создайте DB, используя параметры из .env.local
5. Примените миграции
    ```bash
   alembic upgrade head 
    ```
6. Запустите сервер
   ```bash
   uvicorn main:app --reload
   ```

## Запуск автотестов

1. Создайте тестовую DB, используя параметры из .env.local
2. Запустите автотесты
   ```bash
   pytest -v
   ```


# History

## Урок 10

- добавили зависимости в `requirements.txt`
- создали `.gitignore`

**commit: `Урок 10: init`**

### 1. Основные файлы и конфигурация

- **`main.py`**:
  - Этот файл является точкой входа в ваше FastAPI приложение.
  - Он инициализирует приложение FastAPI и подключает маршрутизаторы (`routers`) для обработки запросов, связанных с потерянными и найденными предметами.
  - Содержит базовый эндпоинт `/`, который возвращает приветственное сообщение.

- **`config.py`**:
  - Содержит настройки приложения, такие как параметры подключения к базе данных.
  - Использует Pydantic для валидации и загрузки переменных окружения из файла `.env.local`.

- **`.env.local.example`**:
  - Пример файла переменных окружения, который используется для настройки параметров базы данных и других конфигураций.
  - Пользователи должны создать файл `.env.local` на основе этого примера и заполнить его своими данными.

### 2. База данных и модели

- **`database.py`**:
  - Настраивает подключение к базе данных с использованием SQLAlchemy.
  - Создает асинхронный движок и сессию для взаимодействия с базой данных.

- **`models.py`**:
  - Определяет модели данных для таблиц `lost_items` и `found_items`.
  - Использует SQLAlchemy ORM для определения структуры таблиц и их полей.
  - Каждая модель соответствует таблице в базе данных и определяет поля, такие как `id`, `name`, `description`, `date`, и `location`.

### 3. Маршрутизаторы и эндпоинты

- **`routers/lost_items.py` и `routers/found_items.py`**:
  - Определяют маршрутизаторы для обработки HTTP-запросов, связанных с потерянными и найденными предметами.
  - Каждый маршрутизатор содержит CRUD (Create, Read, Update, Delete) операции для соответствующих моделей.
  - Используют Pydantic схемы для валидации входных данных и сериализации ответов.

### 4. Схемы данных

- **`schemas.py`**:
  - Определяет Pydantic схемы для валидации данных, поступающих в API, и для сериализации данных, возвращаемых из API.
  - Содержит схемы для создания, обновления и чтения потерянных и найденных предметов.

### 5. Тестирование

- **`conftest.py`**:
  - Содержит фикстуры для настройки тестовой базы данных и клиента FastAPI.
  - Использует `pytest` и `pytest-asyncio` для асинхронного тестирования.
  - Фикстуры обеспечивают изоляцию тестов, создавая и уничтожая тестовую базу данных перед и после выполнения тестов.

- **`test_found_items.py` и `test_lost_items.py`**:
  - Содержат тесты для проверки функциональности эндпоинтов, связанных с найденными и потерянными предметами.
  - Включают тесты для создания, чтения, обновления и удаления предметов, а также проверки на корректность обработки ошибок (например, когда предмет не найден).

### 6. Миграции базы данных

- **`alembic.ini` и `alembic/env.py`**:
  - Конфигурационные файлы для Alembic, инструмента для управления миграциями базы данных.
  - `alembic.ini` содержит основные настройки, такие как путь к скриптам миграций.
  - `env.py` настраивает окружение для выполнения миграций, подключаясь к базе данных и используя метаданные моделей.

- **`789953bf9c87_init_migrations.py`**:
  - Автоматически сгенерированная миграция, которая создает таблицы `found_items` и `lost_items` в базе данных.
  - Содержит команды для создания и удаления таблиц и индексов.

**commit: `Урок 10: создан простой FastAPI проект`**


## Урок 11

1. **Обновление README.md:**
   - Добавлен новый раздел "Урок 11", который описывает команды для создания и применения миграции, добавляющей категории к потерянным предметам.
   - Указаны команды `alembic revision --autogenerate -m "add category to lost items"` и `alembic upgrade head` для генерации и применения миграции.

2. **Изменения в models.py:**
   - Добавлена новая модель `Category`, представляющая категории, к которым могут относиться потерянные предметы.
   - В модель `LostItem` добавлены поля `category_id` и `category`, которые устанавливают связь с моделью `Category`.
   - Используется `relationship` для установки двусторонней связи между `LostItem` и `Category`.

3. **Изменения в routers/lost_items.py:**
   - В маршруте создания потерянного предмета добавлена проверка существования категории по `category_id`.
   - Если категория не найдена, возвращается ошибка `404 Not Found`.

4. **Изменения в schemas.py:**
   - В схему `LostItemBase` добавлено поле `category_id` для валидации данных, связанных с категорией.
   - Добавлены новые схемы `CategoryCreate`, `CategoryUpdate`, и `CategoryRead` для работы с категориями.
   - Эти схемы позволяют создавать, обновлять и читать данные категорий, обеспечивая валидацию и сериализацию.

**Зачем нужны эти изменения:**

- Введение категорий позволяет лучше структурировать данные о потерянных предметах, упрощая их фильтрацию и организацию.
- Проверка существования категории при создании предмета предотвращает ошибки, связанные с несуществующими категориями.
- Новые схемы для категорий обеспечивают согласованность и валидацию данных на уровне API.

- создание файла миграции:
`alembic revision --autogenerate -m "add category to lost items"`
- после этого нужно внести изменения в новый файл миграций в разделах `upgrade` и `downgrade` для того чтобы можно было накатить миграции на непустую базу.
- после внесения изменений в файл миграции, применить миграцию:
`alembic upgrade head`

**commit: `Урок 11: добавлены категории к потерянным предметам`**

1. **Изменения в models.py:**
   - В модель `Category` добавлено поле `found_items`, которое устанавливает связь с моделью `FoundItem`.
   - В модель `FoundItem` добавлены поля `category_id` и `category`, которые устанавливают связь с моделью `Category`.
   - Используется `relationship` для установки двусторонней связи между `FoundItem` и `Category`.

**Зачем нужны эти изменения:**

- Введение категорий для найденных предметов позволяет лучше структурировать данные, упрощая их фильтрацию и организацию.
- Связь между `FoundItem` и `Category` обеспечивает согласованность данных и позволяет легко определять, к какой категории относится найденный предмет.
- Обновление README.md помогает пользователям понять, как создавать и применять миграции, а также учитывать особенности работы с непустой базой данных.

- создание файла миграции:
`alembic revision --autogenerate -m "add category to found items"`
- после этого нужно внести изменения в новый файл миграций в разделах `upgrade` и `downgrade` для того чтобы можно было накатить миграции на непустую базу.
- после внесения изменений в файл миграции, применить миграцию:
`alembic upgrade head`

**commit: `Урок 11 (ПРАКТИКА): добавлены категории к найденным предметам`**

1. **Обновление main.py:**
   - Добавлен новый маршрутизатор `categories_router` для обработки запросов, связанных с категориями.
   - Подключен маршрутизатор к основному приложению FastAPI с префиксом `/categories` и тегом `["categories"]`.

2. **Изменения в routers/found_items.py:**
   - В маршруте создания найденного предмета добавлена проверка существования категории по `category_id`.
   - Если категория не найдена, возвращается ошибка `404 Not Found`.

3. **Изменения в schemas.py:**
   - В схему `FoundItemBase` добавлено поле `category_id` для валидации данных, связанных с категорией.
   - Это позволяет убедиться, что при создании найденного предмета указывается существующая категория.

**Зачем нужны эти изменения:**

- Введение маршрутизатора для категорий позволяет управлять категориями через API, добавляя, обновляя и удаляя их.
- Проверка существования категории при создании найденного предмета предотвращает ошибки, связанные с несуществующими категориями.
- Обновление схемы для найденных предметов обеспечивает согласованность и валидацию данных на уровне API.

**commit: `Урок 11 (ПРАКТИКА): добавлены маршрутизаторы для категорий и связаны найденные предметы с категориями`**

**commit: `Урок 11 (FIX): хотфикс, настройки подключения к БД`**
